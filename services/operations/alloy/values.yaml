serviceMonitor:
  enabled: true

# ---------------------------------------------------------------------------
# GeoIP database init container (MaxMind GeoLite2-City)
# ---------------------------------------------------------------------------
controller:
  initContainers:
    - name: geoip-download
      # renovate: datasource=docker
      image: maxmindinc/geoipupdate:v7.1
      env:
        - name: GEOIPUPDATE_EDITION_IDS
          value: GeoLite2-City
        - name: GEOIPUPDATE_DB_DIR
          value: /geoip
        - name: GEOIPUPDATE_ACCOUNT_ID
          valueFrom:
            secretKeyRef:
              name: maxmind-license
              key: GEOIPUPDATE_ACCOUNT_ID
        - name: GEOIPUPDATE_LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: maxmind-license
              key: GEOIPUPDATE_LICENSE_KEY
      volumeMounts:
        - name: geoip-db
          mountPath: /geoip
  volumes:
    extra:
      - name: geoip-db
        emptyDir: {}

# Expose OTLP ports for trace ingestion
alloy:
  mounts:
    extra:
      - name: geoip-db
        mountPath: /geoip
  extraPorts:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP
  configMap:
    create: true
    content: |
      // -----------------------------------------------------------------------
      // Kubernetes pod log collection (API-based, no privileged access needed)
      // -----------------------------------------------------------------------

      // Discover all pods on this node
      discovery.kubernetes "pods" {
        role = "pod"
        selectors {
          role  = "pod"
          field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
        }
      }

      // Extract useful labels from pod metadata
      discovery.relabel "pod_logs" {
        targets = discovery.kubernetes.pods.targets

        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          action        = "replace"
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          action        = "replace"
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          action        = "replace"
          target_label  = "container"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          action        = "replace"
          target_label  = "app"
        }
        rule {
          source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_container_name"]
          action        = "replace"
          target_label  = "job"
          separator     = "/"
        }
      }

      // Tail logs via the Kubernetes API
      loki.source.kubernetes "pod_logs" {
        targets    = discovery.relabel.pod_logs.output
        forward_to = [loki.process.pod_logs.receiver]
      }

      // Add cluster label and enrich Traefik access logs with GeoIP
      loki.process "pod_logs" {
        stage.static_labels {
          values = {
            cluster = "homelab",
          }
        }

        // GeoIP enrichment for Traefik access-log lines
        stage.match {
          selector   = "{app=\"traefik\"}"
          pipeline_name = "geoip"

          stage.json {
            expressions = {
              client_ip = "ClientHost",
            }
          }

          stage.geoip {
            source   = "client_ip"
            db       = "/geoip/GeoLite2-City.mmdb"
            db_type  = "city"
          }

          stage.labels {
            values = {
              geoip_country_code = "",
            }
          }

          stage.structured_metadata {
            values = {
              geoip_city         = "",
              geoip_country_name = "",
              geoip_latitude     = "",
              geoip_longitude    = "",
            }
          }
        }

        forward_to = [loki.write.default.receiver]
      }

      // -----------------------------------------------------------------------
      // Kubernetes cluster events
      // -----------------------------------------------------------------------

      loki.source.kubernetes_events "cluster_events" {
        job_name   = "integrations/kubernetes/eventhandler"
        log_format = "logfmt"
        forward_to = [loki.process.cluster_events.receiver]
      }

      loki.process "cluster_events" {
        stage.static_labels {
          values = {
            cluster = "homelab",
          }
        }
        forward_to = [loki.write.default.receiver]
      }

      // -----------------------------------------------------------------------
      // Loki write endpoint
      // -----------------------------------------------------------------------

      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"
        }
      }

      // -----------------------------------------------------------------------
      // OTLP receiver (traces from Traefik and other services)
      // -----------------------------------------------------------------------

      otelcol.receiver.otlp "default" {
        grpc {
          endpoint = "0.0.0.0:4317"
        }
        http {
          endpoint = "0.0.0.0:4318"
        }
        output {
          traces = [otelcol.exporter.otlp.tempo.input]
        }
      }

      otelcol.exporter.otlp "tempo" {
        client {
          endpoint = "tempo.monitoring.svc.cluster.local:4317"
          tls {
            insecure = true
          }
        }
      }
