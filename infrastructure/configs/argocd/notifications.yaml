apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications-cm
    app.kubernetes.io/part-of: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
data:
  context: |
    argocdUrl: https://argocd.internal.starktastic.net

  service.webhook.ntfy: |
    url: http://ntfy.operations.svc.cluster.local
    headers:
      - name: Authorization
        value: $ntfy-header
      - name: Content-Type
        value: application/json

  template.app-sync-failed: |
    webhook:
      ntfy:
        method: POST
        body: |
          {
            "topic": "ops",
            "title": "Sync Failed: {{.app.metadata.name}}",
            "message": "Reason: {{.app.status.operationState.message}}",
            "tags": ["skull", "error"],
            "priority": 5,
            "actions": [{
              "action": "view",
              "label": "Open ArgoCD",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
            }]
          }

  template.app-health-degraded: |
    webhook:
      ntfy:
        method: POST
        body: |
          {
            "topic": "ops",
            "title": "Degraded: {{.app.metadata.name}}",
            "message": "Application health has degraded. Check ArgoCD for details.",
            "tags": ["rotating_light", "warning"],
            "priority": 4,
            "actions": [{
              "action": "view",
              "label": "Open ArgoCD",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
            }]
          }

  trigger.on-sync-failed: |
    - description: Application syncing has failed
      send: [app-sync-failed]
      when: app.status.operationState.phase in ['Error', 'Failed']

  trigger.on-health-degraded: |
    - description: Application health has degraded (not during a sync)
      send: [app-health-degraded]
      when: app.status.health.status == 'Degraded' && app.status.operationState.phase not in ['Running']
      oncePer: app.status.health.status
