name: Validate manifests and generate ArgoCD diff preview

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/**'
      - 'scripts/**'
      - '.github/workflows/**'
      - '.github/yamllint.yaml'

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.x'
          pip-install: 'yamllint'

      - name: YAML Lint
        id: yamllint
        run: |
          set +e
          yamllint . > yamllint.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -ne 0 ]; then echo "❌ YAML Lint Failed"; else echo "✅ YAML Lint Passed"; fi
        env:
          YAMLLINT_CONFIG_FILE: .github/yamllint.yaml

      - name: Setup Kubeconform
        env:
          # renovate: datasource=github-releases depName=yannh/kubeconform
          KUBECONFORM_VERSION: 'v0.7.0'
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz | tar xz
          echo "$PWD" >> $GITHUB_PATH

      - name: Validate static manifests
        id: kubeconform
        run: |
          set +e
          find . -type f -name '*.yaml' -path '*/manifests/*' -print0 | xargs -0 kubeconform \
            -verbose -summary -ignore-missing-schemas -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' > kubeconform.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -ne 0 ]; then echo "❌ Kubeconform Failed"; else echo "✅ Kubeconform Passed"; fi

      - name: Create validation report
        if: always()
        run: |
          echo "## Static Validation" > validation-report.md
          echo "" >> validation-report.md

          if [ "${{ steps.yamllint.outputs.exit_code }}" -eq 0 ]; then
            echo "✅ **YAML Lint:** Passed" >> validation-report.md
          else
            echo "❌ **YAML Lint:** FAILED" >> validation-report.md
            echo "" >> validation-report.md
            echo "<details>" >> validation-report.md
            echo "<summary>Log</summary>" >> validation-report.md
            echo "" >> validation-report.md
            echo '```' >> validation-report.md
            cat yamllint.txt >> validation-report.md
            echo '```' >> validation-report.md
            echo "" >> validation-report.md
            echo "</details>" >> validation-report.md
          fi

          if [ "${{ steps.kubeconform.outputs.exit_code }}" -eq 0 ]; then
             echo "✅ **Kubeconform:** Passed" >> validation-report.md
             echo "" >> validation-report.md
             echo "<details>" >> validation-report.md
             echo "<summary>Summary</summary>" >> validation-report.md
             echo "" >> validation-report.md
             echo '```' >> validation-report.md
             tail -n 5 kubeconform.txt >> validation-report.md
             echo '```' >> validation-report.md
             echo "" >> validation-report.md
             echo "</details>" >> validation-report.md
          else
             echo "❌ **Kubeconform:** FAILED" >> validation-report.md
             echo "" >> validation-report.md
             echo "<details>" >> validation-report.md
             echo "<summary>Log</summary>" >> validation-report.md
             echo "" >> validation-report.md
             echo '```' >> validation-report.md
             cat kubeconform.txt >> validation-report.md
             echo '```' >> validation-report.md
             echo "" >> validation-report.md
             echo "</details>" >> validation-report.md
          fi

          echo "" >> validation-report.md

      - name: Upload validation report artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: validation-report
          path: validation-report.md
          retention-days: 1

      - name: Check status
        if: steps.yamllint.outputs.exit_code != 0 || steps.kubeconform.outputs.exit_code != 0
        run: exit 1

  diff:
    name: ArgoCD diff preview
    needs: validate
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          path: pull-request

      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: main
          path: main

      - name: Generate diff
        env:
          # renovate: datasource=docker depName=dagandersen/argocd-diff-preview
          DIFF_PREVIEW_VERSION: 'v0.1.24'
        run: |
          docker run \
            --network=host \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/main:/base-branch \
            -v $(pwd)/pull-request:/target-branch \
            -v $(pwd)/output:/output \
            -e TARGET_BRANCH=${{ github.head_ref }} \
            -e REPO=${{ github.repository }} \
            -e AUTO_DETECT_FILES_CHANGED=true \
            -e WATCH_IF_NO_WATCH_PATTERN_FOUND=false \
            -e MAX_DIFF_LENGTH=65536 \
            dagandersen/argocd-diff-preview:$DIFF_PREVIEW_VERSION

      - name: Upload diff artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: diff-report
          path: output/diff.md
          retention-days: 1

  report:
    name: Report status
    needs: [validate, diff]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Assemble comment
        run: |
          touch comment.md

          if [ -f artifacts/validation-report.md ]; then
            cat artifacts/validation-report.md >> comment.md
            echo "" >> comment.md
            echo "---" >> comment.md
            echo "" >> comment.md
          fi

          if [ -f artifacts/diff.md ]; then
            cat artifacts/diff.md >> comment.md
          fi

      - name: Post comment
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          header: ci-report
          path: comment.md
