container_runtime: containerd

# ---------------------------------------------------------------------------
# Config - LAPI configuration overrides (merged with default config.yaml)
# ---------------------------------------------------------------------------
config:
  config.yaml.local: |
    db_config:
      flush:
        agents_autodelete:
          # Auto-clean stale agent registrations that haven't heartbeated.
          # This prevents "user already exist" errors when agent pods restart
          # and try to re-register with the same machine name.
          login_password: 10m
    api:
      server:
        auto_registration:
          enabled: true
          token: "${REGISTRATION_TOKEN}"
          allowed_ranges:
            - "127.0.0.1/32"
            - "10.0.0.0/8"

# ---------------------------------------------------------------------------
# LAPI (Local API) - central decision engine
# ---------------------------------------------------------------------------
lapi:
  env:
    # Pre-register the Traefik bouncer with a known key
    - name: BOUNCER_KEY_traefik
      valueFrom:
        secretKeyRef:
          name: crowdsec-secrets
          key: bouncer-key
    - name: ENROLL_KEY
      valueFrom:
        secretKeyRef:
          name: crowdsec-secrets
          key: enroll-key
    - name: ENROLL_INSTANCE_NAME
      value: "homelab"
    - name: ENROLL_TAGS
      value: "k3s homelab"

  persistentVolume:
    data:
      enabled: true
      accessModes:
        - ReadWriteOnce
      storageClassName: nfs-pv # IMPORTANT: must match global.storageClass in templates/globals.yaml
      size: 1Gi
    config:
      enabled: true
      accessModes:
        - ReadWriteOnce
      storageClassName: nfs-pv # IMPORTANT: must match global.storageClass in templates/globals.yaml
      size: 100Mi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# ---------------------------------------------------------------------------
# Agent - reads log sources and sends alerts to LAPI
# ---------------------------------------------------------------------------
agent:
  env:
    - name: COLLECTIONS
      value: >-
        crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/base-http-scenarios

  acquisition:
    - namespace: traefik-system
      podName: traefik-*
      program: traefik
      poll_without_inotify: true

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

  # Allow running on control-plane nodes (Traefik runs there too)
  tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"
