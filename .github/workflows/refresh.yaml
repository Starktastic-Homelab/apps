name: Refresh ArgoCD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  refresh:
    name: Trigger refresh
    runs-on: self-hosted
    container:
      image: buildpack-deps:scm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for app-relevant changes
        id: guard
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BEFORE="${{ github.event.before }}"

          # First push or force-push with no prior SHA — can't diff, so don't skip
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "No previous SHA available — refreshing to be safe"
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get changed files — if the before SHA is unreachable (force push / rebase), fall back to refreshing
          CHANGED=$(git diff --name-only "$BEFORE" "${{ github.sha }}" 2>/dev/null) || {
            echo "Before SHA unreachable (likely force push) — refreshing to be safe"
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          }
          echo "Changed files:"
          echo "$CHANGED"

          # Skip refresh if changes only touch non-app files (README, scripts, renovate, .github, etc.)
          if echo "$CHANGED" | grep -qE '^(services/|infrastructure/|templates/|bootstrap/)'; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "No app-relevant changes — skipping refresh"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Kubeconfig
        if: steps.guard.outputs.skip != 'true'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_RAW }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Setup Kubectl
        if: steps.guard.outputs.skip != 'true'
        uses: azure/setup-kubectl@v4.0.1
        with:
          version: 'latest'

      - name: Setup ArgoCD CLI
        if: steps.guard.outputs.skip != 'true'
        uses: clowdhaus/argo-cd-action@main
        with:
          command: version
          options: --client

      - name: Hard-refresh applications
        if: steps.guard.outputs.skip != 'true'
        run: |
          kubectl config set-context --current --namespace=argocd

          echo 'Triggering hard refresh on all apps...'

          argocd app list --core -o name | xargs -P 10 -I {} sh -c '
            argocd app get "$1" --core --refresh > /dev/null && echo "✓ $1" || echo "✗ $1"
          ' _ {}

          echo 'Refresh complete. ArgoCD will auto-sync changes shortly.'
