apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: platform-apps
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=zero"]
  generators:
    - matrix:
        generators:
          - list:
              elements:
                - category: infrastructure
                  pathPattern: "apps/infrastructure/**/app.yaml"
                  syncWaveDefault: "0"
                  commonValues: "apps/templates/infra-common.yaml"
                  defaultChartRepo: ""
                  defaultChartName: ""
                  defaultChartVersion: ""
                  # Network config for inline value injection
                  network:
                    loadBalancers:
                      external: "10.9.8.90"
                      internal: "10.9.9.90"
                - category: services
                  pathPattern: "apps/services/**/app.yaml"
                  syncWaveDefault: "5"
                  commonValues: "apps/templates/common.yaml"
                  defaultChartRepo: "https://bjw-s-labs.github.io/helm-charts"
                  defaultChartName: "app-template"
                  defaultChartVersion: "4.6.2"
          - git:
              repoURL: https://github.com/Starktastic-Homelab/platform.git
              revision: HEAD
              files:
                - path: "{{ .pathPattern }}"
  template:
    metadata:
      name: "{{.name}}"
      namespace: argocd
      finalizers: ["resources-finalizer.argocd.argoproj.io"]
      annotations:
        argocd.argoproj.io/sync-wave: '{{ .syncWave | default .syncWaveDefault }}'
        notifications.argoproj.io/subscribe.on-sync-failed.ntfy: ""
    spec:
      project: default
      sources: []
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{ .namespace }}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
  templatePatch: |
    {{- $repo := "https://github.com/Starktastic-Homelab/platform.git" }}
    {{- $isService := eq .category "services" }}
    {{- $isTraefik := eq .name "traefik" }}
    spec:
      sources:
        {{- if $isService }}
        - repoURL: '{{ dig "chart" "repo" .defaultChartRepo . }}'
          chart: '{{ dig "chart" "name" .defaultChartName . }}'
          targetRevision: '{{ dig "chart" "version" .defaultChartVersion . }}'
          helm:
            valueFiles:
              - $values/{{ .commonValues }}
              - $values/{{.path.path}}/values.yaml
        {{- else if $isTraefik }}
        - repoURL: "{{ .chart.repo }}"
          chart: "{{ .chart.name }}"
          targetRevision: "{{ .chart.version }}"
          helm:
            valueFiles:
              - $values/{{ .commonValues }}
              - $values/{{.path.path}}/values.yaml
            values: |
              service:
                enabled: true
                type: LoadBalancer
                single: true
                annotations:
                  kube-vip.io/loadbalancerIPs: "{{ .network.loadBalancers.external }}"
                  argocd.argoproj.io/sync-wave: "0"
                spec:
                  loadBalancerIP: "{{ .network.loadBalancers.external }}"
                  externalTrafficPolicy: Local
                additionalServices:
                  internal:
                    type: LoadBalancer
                    annotations:
                      kube-vip.io/loadbalancerIPs: "{{ .network.loadBalancers.internal }}"
                      argocd.argoproj.io/sync-wave: "0"
                    spec:
                      loadBalancerIP: "{{ .network.loadBalancers.internal }}"
                      externalTrafficPolicy: Local
              ports:
                web:
                  expose:
                    default: true
                    internal: false
                websecure:
                  expose:
                    default: true
                    internal: false
                web-int:
                  expose:
                    default: false
                    internal: true
                websec-int:
                  expose:
                    default: false
                    internal: true
        {{- else }}
        - repoURL: "{{ .chart.repo }}"
          chart: "{{ .chart.name }}"
          targetRevision: "{{ .chart.version }}"
          helm:
            valueFiles:
              - $values/{{ .commonValues }}
              - $values/{{.path.path}}/values.yaml
        {{- end }}
        - repoURL: {{ $repo }}
          targetRevision: HEAD
          ref: values
        {{- if and $isService (dig "ingress" "enabled" false .) }}
        - repoURL: {{ $repo }}
          targetRevision: HEAD
          path: apps/templates/ingress-chart
          helm:
            valueFiles:
              - $values/{{.path.path}}/app.yaml
        {{- end }}
        - repoURL: {{ $repo }}
          targetRevision: HEAD
          path: '{{.path.path}}/manifests'
