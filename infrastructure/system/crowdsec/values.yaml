container_runtime: containerd

# ---------------------------------------------------------------------------
# LAPI (Local API) - central decision engine
# ---------------------------------------------------------------------------
lapi:
  env:
    # Pre-register the Traefik bouncer with a known key
    - name: BOUNCER_KEY_traefik
      valueFrom:
        secretKeyRef:
          name: crowdsec-secrets
          key: bouncer-key
    - name: ENROLL_INSTANCE_NAME
      value: "homelab"
    - name: ENROLL_TAGS
      value: "k3s homelab"

  persistentVolume:
    data:
      enabled: true
      accessModes:
        - ReadWriteOnce
      storageClassName: nfs-pv # source: globals.yaml → global.storageClass
      size: 1Gi
    config:
      enabled: true
      accessModes:
        - ReadWriteOnce
      storageClassName: nfs-pv # source: globals.yaml → global.storageClass
      size: 100Mi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# ---------------------------------------------------------------------------
# Agent - reads log sources and sends alerts to LAPI
# ---------------------------------------------------------------------------
agent:
  env:
    - name: COLLECTIONS
      value: >-
        crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/base-http-scenarios

  acquisition:
    - namespace: traefik-system
      podName: traefik-*
      program: traefik
      poll_without_inotify: true

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

  # Allow running on control-plane nodes (Traefik runs there too)
  tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"
