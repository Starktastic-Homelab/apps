{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:recommended"],
  "argocd": {
    "managerFilePatterns": ["/\\.yaml$/"]
  },
  "kubernetes": {
    "managerFilePatterns": ["/\\.yaml$/"]
  },
  "helm-values": {
    "managerFilePatterns": ["!/^(infrastructure|services)/.*/values\\.yaml$/"]
  },
  "packageRules": [
    {
      "description": "Block Ubuntu base-image version tags (e.g. 20.04.1) on LinuxServer images",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["/^lscr\\.io/linuxserver//"],
      "allowedVersions": "!/^\\d{2}\\.04/"
    },
    {
      "description": "Block old LinuxServer libtorrent-based tags for qBittorrent",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["lscr.io/linuxserver/qbittorrent"],
      "allowedVersions": "< 6.0.0"
    }
  ],
  "customManagers": [
    {
      "description": "Update default app-template in cluster-apps AppSet",
      "customType": "regex",
      "managerFilePatterns": ["/^bootstrap/appsets/cluster-apps\\.yaml$/"],
      "matchStrings": [
        "defaultChartRepo: \"(?<registryUrl>.*?)\"[\\s\\S]*?defaultChartName: \"(?<depName>.*?)\"[\\s\\S]*?defaultChartVersion: \"(?<currentValue>.*?)\""
      ],
      "datasourceTemplate": "helm",
      "fileFormat": "yaml"
    },
    {
      "description": "Update Helm charts in app.yaml via JSONata",
      "customType": "jsonata",
      "managerFilePatterns": ["/^(infrastructure|services)/.*/app\\.yaml$/"],
      "matchStrings": ["chart.{ 'depName': name, 'registryUrl': repo, 'currentValue': version }"],
      "datasourceTemplate": "helm",
      "fileFormat": "yaml"
    },
    {
      "description": "Update Docker images + digests in Helm values",
      "customType": "regex",
      "managerFilePatterns": ["/^(infrastructure|services)/.*/values\\.yaml$/"],
      "matchStrings": [
        "repository: (?<depName>\\S+)\\n\\s+tag: (?<currentValue>\\S+)\\n\\s+digest: (?<currentDigest>sha256:[a-f0-9]+)"
      ],
      "autoReplaceStringTemplate": "repository: {{{depName}}}\n          tag: {{{newValue}}}\n          digest: {{{newDigest}}}",
      "datasourceTemplate": "docker"
    },
    {
      "description": "Update Docker images (no digest) in Helm values",
      "customType": "regex",
      "managerFilePatterns": ["/^(infrastructure|services)/.*/values\\.yaml$/"],
      "matchStrings": [
        "repository: (?<depName>\\S+)\\n\\s+tag: (?<currentValue>\\S+)(?!\\n\\s+digest:)"
      ],
      "datasourceTemplate": "docker"
    },
    {
      "description": "Update image references in CRD manifests via renovate comments",
      "customType": "regex",
      "managerFilePatterns": ["/^(infrastructure|services)/.*\\.yaml$/"],
      "matchStrings": [
        "# renovate: datasource=(?<datasource>\\S+)\\n\\s+\\S+:\\s*\"?(?<depName>[^:\"\\s]+):(?<currentValue>[^\"\\s]+)\"?"
      ],
      "datasourceTemplate": "{{datasource}}"
    },
    {
      "description": "Update pinned tool versions in CI workflows",
      "customType": "regex",
      "managerFilePatterns": ["/^\\.github/workflows/.*\\.yml$/"],
      "matchStrings": [
        "# renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)\\s+\\w+:\\s*'(?<currentValue>[^']+)'"
      ],
      "datasourceTemplate": "{{datasource}}"
    },
    {
      "description": "Update Traefik plugin versions",
      "customType": "regex",
      "managerFilePatterns": ["/^infrastructure/controllers/traefik/values\\.yaml$/"],
      "matchStrings": [
        "moduleName: github\\.com/(?<depName>\\S+)\\n\\s+version: (?<currentValue>\\S+)"
      ],
      "datasourceTemplate": "github-releases"
    }
  ]
}
